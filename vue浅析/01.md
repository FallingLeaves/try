## 项目了解

### 目录

    dist --------------------------------------------- 构建后文件目录
    flow --------------------------------------------- 类型声明
    packages ----------------------------------------- 存放独立发布的包的目录
    scripts ------------------------------------------ 构建相关的文件
    | -- git-hooks ----------------------------------- 存放git钩子的目录
    | -- alias.js ------------------------------------ 别名配置
    | -- build.js ------------------------------------ 对config.js中rollup配置进行构建
    | -- config.js ----------------------------------- rollup配置文件
    | -- gen-release-note.js -------------------------
    | -- get-weex-version.js -------------------------
    | -- release-weex.sh -----------------------------
    | -- release.sh ----------------------------------
    | -- verify-commit-msg.js ------------------------
    src ---------------------------------------------- 源码
    | -- compiler ------------------------------------ 编译器代码存放目录，将template编译成render函数
    | -- core ----------------------------------------
         | -- components ----------------------------- 通用组件
         | -- global-api ----------------------------- 给vue构造函数挂载全局方法或属性的代码
         | -- instance ------------------------------- vue构造函数设计相关的代码
         | -- observer ------------------------------- 反应系统，包含数据观测的核心代码
         | -- util -----------------------------------
         | -- vdom ----------------------------------- 虚拟DOM创建
         | -- config.js ------------------------------
         | -- index.js -------------------------------
    | -- platforms ----------------------------------- 平台特有相关代码
         | -- web ------------------------------------ web平台
              | -- entry-runtime.js ------------------ 运行时构建的入口
              | -- entry-runtime-with-compiler.js ---- 独立构建版本的入口，在 runtime 的基础添加 模板到render函数中
              | -- entry-compiler.js ----------------- vue-template-compiler包的入口文件
              | -- entry-server-renderer.js ---------- vue-server-renderer包的入口文件
              | -- entry-server-basic-renderer.js ---- 输出packages/vue-server-renderer/basic.js
         | -- weex ----------------------------------- 混合应用
    | -- sfc ----------------------------------------- 包含单文件组件(.vue文件)的解析逻辑，用于vue-template-compiler包
    | -- shared -------------------------------------- 包含整个代码库通用代码
    | -- server -------------------------------------- 服务端渲染相关代码
    test --------------------------------------------- 测试文件
    package.json -------------------------------------
    yarn.lock ---------------------------------------- yarn 锁定文件
    .editorconfig ------------------------------------ 针对编辑器编码风格的配置文件
    .flowconfig -------------------------------------- flow的配置文件
    .babelrc ----------------------------------------- babel的配置文件
    .eslintrc ---------------------------------------- eslint的配置文件
    .eslintignore ------------------------------------ eslint的忽略文件
    .gitignore --------------------------------------- git的忽略文件忽略

### vue 构造函数

    * vue 构造函数的原型
      `npm run dev` 执行`"dev": "rollup -w -c scripts/config.js --environment TARGET:web-full-dev"`
      根据`scripts/config.js`中的代码进行配置
      'web-full-dev': {
        entry: resolve('web/entry-runtime-with-compiler.js'),  入口文件
        dest: resolve('dist/vue.js'),  输出文件
        format: 'umd',
        env: 'development',
        alias: { he: './entity-decoder' },
        banner
      }
      web：别名配置，web: resolve('src/platforms/web'),
      入口：src/platforms/web/entry-runtime-with-compiler.js

      入口文件entry-runtime-with-compiler.js中
      import Vue from './runtime/index'
      Vue.prototype.$mount = .....

      runtime/index中
      import Vue from 'core/index'
      Vue.prototype.__patch__ = inBrowser ? patch : noop
      Vue.prototype.$mount = .....

      core：别名配置 core: resolve('src/core'),

      src/core/index中
      import Vue from './instance/index'
      Object.defineProperty(Vue.prototype, '$isServer', {
        get: isServerRendering
      })

      Object.defineProperty(Vue.prototype, '$ssrContext', {
        get () {
          /* istanbul ignore next */
          return this.$vnode && this.$vnode.ssrContext
        }
      })

      instance/index中
      导入五种方法
      import { initMixin } from './init'
      import { stateMixin } from './state'
      import { renderMixin } from './render'
      import { eventsMixin } from './events'
      import { lifecycleMixin } from './lifecycle'
      import { warn } from '../util/index'
      定义vue函数
      function Vue (options) {
        if (process.env.NODE_ENV !== 'production' &&
          !(this instanceof Vue)
        ) {
          warn('Vue is a constructor and should be called with the `new` keyword')
        }
        this._init(options)
      }
      将vue作为参数传入
      initMixin(Vue)
      stateMixin(Vue)
      eventsMixin(Vue)
      lifecycleMixin(Vue)
      renderMixin(Vue)
      导出vue
      export default Vue

      在./init中 initMixin

      export function initMixin (Vue: Class<Component>) {
        Vue.prototype._init = function (options?: Object) {
          .....
        }
      }

      在vue原型上添加_init方法，在vue构造函数会执行该方法

      在./state中 stateMixin
      Object.defineProperty(Vue.prototype, '$data', dataDef)
      Object.defineProperty(Vue.prototype, '$props', propsDef)

      const dataDef = {}
      dataDef.get = function () { return this._data }
      const propsDef = {}
      propsDef.get = function () { return this._props }
      if (process.env.NODE_ENV !== 'production') {
        dataDef.set = function (newData: Object) {
          warn(
            'Avoid replacing instance root $data. ' +
            'Use nested data properties instead.',
            this
          )
        }
        propsDef.set = function () {
          warn(`$props is readonly.`, this)
        }
      }

      在Vue.prototype上添加两个属性($data和$props)，$data其实代理的是_data实例属性，$props代理的_props实例属性

      Vue.prototype.$set = set
      Vue.prototype.$delete = del
      Vue.prototype.$watch = ....

      还在Vue.prototype上定义了$set、$delete、$watch三个方法

      在./events中 eventsMixin

      export function eventsMixin (Vue: Class<Component>) {
        const hookRE = /^hook:/
        Vue.prototype.$on = function (event: string | Array<string>, fn: Function): Component {
          ......
        }

        Vue.prototype.$once = function (event: string, fn: Function): Component {
          ......
        }

        Vue.prototype.$off = function (event?: string | Array<string>, fn?: Function): Component {
          ....
        }

        Vue.prototype.$emit = function (event: string): Component {
          .....
        }
      }

      在Vue.prototype上添加$on、$once、$off、$emit方法

      在./lifecycle中 lifecycleMixin

      export function lifecycleMixin (Vue: Class<Component>) {
        Vue.prototype._update = function (vnode: VNode, hydrating?: boolean) {
          ......
        }

        Vue.prototype.$forceUpdate = function () {
          ...
        }

        Vue.prototype.$destroy = function () {
          ....
        }

      }

      在Vue.prototype上添加_update、$forceUpdate、$destroy方法

      在./render 中 renderMixin

      export function renderMixin (Vue: Class<Component>) {
        installRenderHelpers(Vue.prototype)

        Vue.prototype.$nextTick = function (fn: Function) {
          return nextTick(fn, this)
        }

        Vue.prototype._render = function (): VNode {
          ...
        }

      }

      import { installRenderHelpers } from './render-helpers/index'

      在./render-helpers/index中
      export function installRenderHelpers (target: any) {
        target._o = markOnce
        target._n = toNumber
        target._s = toString
        target._l = renderList
        target._t = renderSlot
        target._q = looseEqual
        target._i = looseIndexOf
        target._m = renderStatic
        target._f = resolveFilter
        target._k = checkKeyCodes
        target._b = bindObjectProps
        target._v = createTextVNode
        target._e = createEmptyVNode
        target._u = resolveScopedSlots
        target._g = bindObjectListeners
      }

      在Vue.prototype原型添加一系列方法和$nextTick、_render


      在src/core/instance/index.js中
      vue的原始出生地，通过 *Mixin 方法在Vue.prototype原型添加方法
      initMixin 添加 _init 方法
      stateMixin 添加 $data $props $set $delete $watch
      eventsMixin 添加 $on $once $off $emit
      lifecycleMixin 添加 _update $forceUpdate $destroy
      renderMixin 添加 _o _n _s _l _t _q _i _m _f _k _b _v _e _u _g $nextTick _render

      在src/core/index.js中
      在Vue.prototype原型添加 $isServer $ssrContext

      在src/platforms/web/runtime/index.js中
      在Vue.prototype原型添加 __patch__ $mount

      在src/platforms/web/entry-runtime-with-compiler.js中
      在Vue.prototype原型添加 $mount


    * vue构造函数的静态属性和方法(全局API)  

      在src/core/index.js 中导入了src/core/instance/index.js暴露的vue
      `
        导入vue
        import Vue from './instance/index'
        import { initGlobalAPI } from './global-api/index'
        import { isServerRendering } from 'core/util/env'
        import { FunctionalRenderContext } from 'core/vdom/create-functional-component'

        initGlobalAPI(Vue)

        Vue.prototype原型上添加$isServer属性，代理了isServerRendering方法
        Object.defineProperty(Vue.prototype, '$isServer', {
          get: isServerRendering
        })

        Vue.prototype原型上添加$ssrContext属性
        Object.defineProperty(Vue.prototype, '$ssrContext', {
          get () {
            /_ istanbul ignore next _/
            return this.$vnode && this.$vnode.ssrContext
          }
        })

        Vue上添加FunctionalRenderContext属性
        // expose FunctionalRenderContext for ssr runtime helper installation
        Object.defineProperty(Vue, 'FunctionalRenderContext', {
          value: FunctionalRenderContext
        })

        Vue.version保存版本号 rollup配置(scripts/config.js)中会替换为版本号
        Vue.version = '__VERSION__'

        export default Vue
      `

      在src/core/global-api/index.js中

      const configDef = {}
      configDef.get = () => config
      if (process.env.NODE_ENV !== 'production') {
        configDef.set = () => {
          warn(
            'Do not replace the Vue.config object, set individual fields instead.'
          )
        }
      }
      Object.defineProperty(Vue, 'config', configDef)

      在Vue上添加config属性

      Vue.util = {
        warn,
        extend,
        mergeOptions,
        defineReactive
      }
      在Vue上添加util属性

      Vue.set = set
      Vue.delete = del
      Vue.nextTick = nextTick
      Vue.options = Object.create(null)

      在Vue上添加set、del、nextTick、options

      ASSET_TYPES.forEach(type => {
        Vue.options[type + 's'] = Object.create(null)
      })
      Vue.options._base = Vue
      这段执行后
      Vue.options = {
        components: Object.create(null),
        directives: Object.create(null),
        filters: Object.create(null),
        _base: Vue
      }

      extend(Vue.options.components, builtInComponents)
      将builtInComponents混合到Vue.options.components中

      Vue.options = {
        components: {
          KeepAlive
        },
        directives: Object.create(null),
        filters: Object.create(null),
        _base: Vue
      }

      import { initUse } from './use'
      initUse(Vue)

      在src/core/global-api/use.js
      export function initUse (Vue: GlobalAPI) {
        Vue.use = function() {
          ....
        }
      }
      在Vue上添加use方法

      import { initMixin } from './mixin'
      initMixin(Vue)

      在src/core/global-api/mixin.js
      export function initMixin (Vue: GlobalAPI) {
        Vue.mixin = function (mixin: Object) {
          ...
        }
      }
      在Vue上添加mixin方法

      import { initExtend } from './extend'
      initExtend(Vue)

      在src/core/global-api/extend.js
      export function initExtend (Vue: GlobalAPI) {
        Vue.cid = 0
        let cid = 1
        Vue.extend = function (extendOptions: Object): Function {
          ...
        }
      }
      在Vue添加cid属性和extend方法

      import { initAssetRegisters } from './assets'
      initAssetRegisters(Vue)

      在src/core/global-api/assets.js
      export function initAssetRegisters (Vue: GlobalAPI) {
        ASSET_TYPES.forEach( type => {
          Vue[type] = function() {
            ...
          }
        })
      }
      在Vue上添加component、directive、filter方法

      src/core/global-api/index.js做的事
      Vue上添加config属性
      Vue上添加util对象包含warn、extend、mergeOptions、defineReactive
      Vue上添加set、delete、nextTick
      Vue上添加options对象
      Vue.options = {
        components: {
          KeepAlive
        },
        directives: Object.create(null),
        filters: Object.create(null),
        _base: Vue
      }
      initUse(Vue) => 在Vue上添加use方法
      initMixin(Vue) => 在Vue上添加mixin方法
      initExtend(Vue) => 在Vue添加cid属性和extend方法
      initAssetRegisters(Vue) => 在Vue上添加component、directive、filter方法

      src/core/index.js
      还在Vue.prototype原型上添加$isServer、$ssrContext
      Vue上添加FunctionalRenderContext、version

      src/platforms/web/entry-runtime-with-compiler.js
      Vue.compile = compileToFunctions


      npm run dev => 执行 src/platforms/web/entry-runtime-with-compiler.js(import Vue from './runtime/index')

      src/platforms/web/runtime/index.js(import Vue from 'core/index' 别名配置)

      src/core/index.js(import Vue from './instance/index') 为Vue添加全局属性方法

      src/core/instance/index.js(Vue出生文件)

    * Vue平台化包装(web和weex)

      src/platforms/web/runtime/index.js

      Vue.config.mustUseProp = mustUseProp
      Vue.config.isReservedTag = isReservedTag
      Vue.config.isReservedAttr = isReservedAttr
      Vue.config.getTagNamespace = getTagNamespace
      Vue.config.isUnknownElement = isUnknownElement

      Vue.config = {
        optionMergeStrategies: Object.create(null),
        silent: false,
        productionTip: process.env.NODE_ENV !== 'production',
        devtools: process.env.NODE_ENV !== 'production',
        performance: false,
        errorHandler: null,
        warnHandler: null,
        ignoredElements: [],
        keyCodes: Object.create(null),
        isReservedTag: no,
        isReservedAttr: no,
        isUnknownElement: no,
        getTagNamespace: noop,
        parsePlatformTagName: identity,
        mustUseProp: no,
        _lifecycleHooks: LIFECYCLE_HOOKS
      }

      import platformDirectives from './directives/index'
      import platformComponents from './components/index'
      extend(Vue.options.directives, platformDirectives)
      extend(Vue.options.components, platformComponents)

      src/platforms/web/runtime/directives/index
      暴露model、show方法
      src/platforms/web/runtime/components/index
      暴露Transition、TransitionGroup组件

      Vue.options = {
        components: {
          KeepAlive,
          Transition,
          TransitionGroup
        },
        directives: {
          model,
          show
        },
        filters: Object.create(null),
        _base: Vue
      }

      Vue.prototype.__patch__ = inBrowser ? patch : noop
      如果是浏览器环境Vue.prototype.__patch__ = patch 否则为空函数

      Vue.prototype.$mount = function() {
        ....
      }
      Vue.prototype原型添加$mount


      src/platforms/web/runtime/index.js做了
      设置平台化的Vue.config
      Vue.options.directives 添加 model、show指令
      Vue.options.components 添加 Transition、TransitionGroup组件
      Vue.prototype上添加__patch__、$mount

    * with complier

      完整版和运行版区别在于 complier

      src/platforms/web/entry-runtime-with-compiler.js

      const idToTemplate = cached(id => {
        const el = query(id)
        return el && el.innerHTML
      })
      通过id获取元素的innerHTML

      const mount = Vue.prototype.$mount
      mount变量缓存Vue.prototype.$mount方法

      function getOuterHTML() {
        ....
      }
      定义getOuterHTML方法

      Vue.prototype.$mount = function(){
        ...
      }
      重写Vue.prototype.$mount方法

      import { compileToFunctions } from './compiler/index'
      Vue.compile = compileToFunctions
      Vue添加compile方法