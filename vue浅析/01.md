## 项目了解

### 目录

```js
dist --------------------------------------------- 构建后文件目录  
flow --------------------------------------------- 类型声明  
packages ----------------------------------------- 存放独立发布的包的目录  
scripts ------------------------------------------ 构建相关的文件  
| -- git-hooks ----------------------------------- 存放 git 钩子的目录  
| -- alias.js ------------------------------------ 别名配置  
| -- build.js ------------------------------------ 对 config.js 中 rollup 配置进行构建  
| -- config.js ----------------------------------- rollup 配置文件  
| -- gen-release-note.js -------------------------  
| -- get-weex-version.js -------------------------  
| -- release-weex.sh -----------------------------  
| -- release.sh ----------------------------------  
| -- verify-commit-msg.js ------------------------  
src ---------------------------------------------- 源码  
| -- compiler ------------------------------------ 编译器代码存放目录，将 template 编译成 render 函数  
| -- core ----------------------------------------  
      | -- components ---------------------------- 通用组件  
      | -- global-api ---------------------------- 给 vue 构造函数挂载全局方法或属性的代码  
      | -- instance ------------------------------ vue 构造函数设计相关的代码  
      | -- observer ------------------------------ 反应系统，包含数据观测的核心代码  
      | -- util ----------------------------------  
      | -- vdom ---------------------------------- 虚拟 DOM 创建  
      | -- config.js -----------------------------  
      | -- index.js ------------------------------  
| -- platforms ----------------------------------- 平台特有相关代码  
      | -- web ----------------------------------- web 平台  
            | -- entry-runtime.js ------------------ 运行时构建的入口  
            | -- entry-runtime-with-compiler.js ---- 独立构建版本的入口，在 runtime 的基础添加 模板到 render 函数中  
            | -- entry-compiler.js ----------------- vue-template-compiler 包的入口文件  
            | -- entry-server-renderer.js ---------- vue-server-renderer 包的入口文件  
            | -- entry-server-basic-renderer.js ---- 输出 packages/vue-server-renderer/basic.js  
      | -- weex ---------------------------------- 混合应用  
| -- sfc ----------------------------------------- 包含单文件组件(.vue 文件)的解析逻辑，用于 vue-template-compiler 包  
| -- shared -------------------------------------- 包含整个代码库通用代码  
| -- server -------------------------------------- 服务端渲染相关代码  
test --------------------------------------------- 测试文件  
package.json -------------------------------------  
yarn.lock ---------------------------------------- yarn 锁定文件  
.editorconfig ------------------------------------ 针对编辑器编码风格的配置文件  
.flowconfig -------------------------------------- flow 的配置文件  
.babelrc ----------------------------------------- babel 的配置文件  
.eslintrc ---------------------------------------- eslint 的配置文件  
.eslintignore ------------------------------------ eslint 的忽略文件  
.gitignore --------------------------------------- git 的忽略文件忽略
```

### vue 构造函数

- vue 构造函数的原型  
  `npm run dev` 执行`"dev": "rollup -w -c scripts/config.js --environment TARGET:web-full-dev"`  
  根据`scripts/config.js`中的代码进行配置

  > 'web-full-dev': {  
  >  &emsp;entry: resolve('web/entry-runtime-with-compiler.js'),入口文件  
  >  &emsp;dest: resolve('dist/vue.js'), 输出文件  
  >  &emsp;format: 'umd',  
  >  &emsp;env: 'development',  
  >  &emsp;alias: { he: './entity-decoder' },  
  >  &emsp;banner  
  > }

  web：别名配置，web: resolve('src/platforms/web'),  
  入口：src/platforms/web/entry-runtime-with-compiler.js

  入口文件 entry-runtime-with-compiler.js 中

  > import Vue from './runtime/index'  
  > Vue.prototype.$mount = .....

  runtime/index 中

  > import Vue from 'core/index'  
  > Vue.prototype.**patch** = inBrowser ? patch : noop  
  > Vue.prototype.$mount = .....

  core：别名配置 core: resolve('src/core'),

  src/core/index 中

  > import Vue from './instance/index'  
  > Object.defineProperty(Vue.prototype, '$isServer', {  
  > &emsp;get: isServerRendering  
  > })  
  > Object.defineProperty(Vue.prototype, '$ssrContext', {  
  > &emsp;get () {  
  > &emsp;&emsp;/_ istanbul ignore next _/  
  > &emsp;&emsp;return this.$vnode && this.$vnode.ssrContext  
  > &emsp;}  
  > })

  instance/index 中  
  导入五种方法

  > import { initMixin } from './init'  
  > import { stateMixin } from './state'  
  > import { renderMixin } from './render'  
  > import { eventsMixin } from './events'  
  > import { lifecycleMixin } from './lifecycle'  
  > import { warn } from '../util/index'  
  > 定义 vue 函数  
  > function Vue (options) {  
  > &emsp;if (process.env.NODE_ENV !== 'production' &&!(this instanceof Vue)) {  
  > &emsp;&emsp;warn('Vue is a constructor and should be called with the `new` keyword')  
  > &emsp;}  
  > &emsp;this.\_init(options)  
  > }  
  > 将 vue 作为参数传入  
  > initMixin(Vue)  
  > stateMixin(Vue)  
  > eventsMixin(Vue)  
  > lifecycleMixin(Vue)  
  > renderMixin(Vue)  
  > 导出 vue  
  > export default Vue

  在./init 中 initMixin

  > export function initMixin (Vue: Class<Component>) {  
  > &emsp;Vue.prototype.\_init = function (options?: Object) {  
  > &emsp;&emsp;.....  
  > &emsp;}  
  > }

  在 vue 原型上添加\_init 方法，在 vue 构造函数会执行该方法

  在./state 中 stateMixin

  > Object.defineProperty(Vue.prototype, '$data', dataDef)  
  > Object.defineProperty(Vue.prototype, '$props', propsDef)  
  > const dataDef = {}  
  > dataDef.get = function () { return this.\_data }  
  > const propsDef = {}  
  > propsDef.get = function () { return this.\_props }  
  > if (process.env.NODE_ENV !== 'production') {  
  > &emsp;dataDef.set = function (newData: Object) {  
  > &emsp;&emsp;warn(  
  > &emsp;&emsp;&emsp;'Avoid replacing instance root $data. ' +  
  > &emsp;&emsp;&emsp;'Use nested data properties instead.',  
  > &emsp;&emsp;&emsp;this  
  > &emsp;&emsp;)  
  > &emsp;}  
  > &emsp;propsDef.set = function () {  
  > &emsp;&emsp;warn(\`$props is readonly.\`, this)  
  > &emsp;}  
  > }

  在 Vue.prototype 上添加两个属性($data 和$props)，$data 其实代理的是\_data 实例属性，$props 代理的\_props 实例属性

  > Vue.prototype.$set = set  
  > Vue.prototype.$delete = del  
  > Vue.prototype.$watch = ....

  还在 Vue.prototype 上定义了$set、$delete、$watch 三个方法

  在./events 中 eventsMixin

  > export function eventsMixin (Vue: Class<Component>) {  
  > &emsp;const hookRE = /^hook:/  
  > &emsp;Vue.prototype.$on = function (event: string | Array<string>, fn: Function): Component {  
  > &emsp;&emsp;......  
  > &emsp;}  
  > &emsp;Vue.prototype.$once = function (event: string, fn: Function): Component {  
  > &emsp;&emsp;......  
  > &emsp;}  
  > &emsp;Vue.prototype.$off = function (event?: string | Array<string>, fn?: Function):&emsp;Component {  
  > &emsp;&emsp;....  
  > &emsp;}  
  > &emsp;Vue.prototype.$emit = function (event: string): Component {  
  > &emsp;&emsp;.....  
  > &emsp;}  
  > }

  在 Vue.prototype 上添加$on、$once、$off、$emit 方法

  在./lifecycle 中 lifecycleMixin

  > export function lifecycleMixin (Vue: Class<Component>) {  
  > &emsp;Vue.prototype.\_update = function (vnode: VNode, hydrating?: boolean) {  
  > &emsp;&emsp;......  
  > &emsp;}  
  > &emsp;Vue.prototype.$forceUpdate = function () {  
  > &emsp;&emsp;...  
  > &emsp;}  
  > &emsp;Vue.prototype.$destroy = function () {  
  > &emsp;&emsp;....  
  > &emsp;}  
  > }

  在 Vue.prototype 上添加\_update、$forceUpdate、$destroy 方法

  在./render 中 renderMixin

  > export function renderMixin (Vue: Class<Component>) {  
  > &emsp;installRenderHelpers(Vue.prototype)  
  > &emsp;Vue.prototype.$nextTick = function (fn: Function) {  
  > &emsp;&emsp;return nextTick(fn, this)  
  > &emsp;}  
  > &emsp;Vue.prototype.\_render = function (): VNode {  
  > &emsp;&emsp;...  
  > &emsp;}  
  > }

  import { installRenderHelpers } from './render-helpers/index'

  在./render-helpers/index 中

  > export function installRenderHelpers (target: any) {
  > &emsp;target.\_o = markOnce  
  > &emsp;target.\_n = toNumber  
  > &emsp;target.\_s = toString  
  > &emsp;target.\_l = renderList  
  > &emsp;target.\_t = renderSlot  
  > &emsp;target.\_q = looseEqual  
  > &emsp;target.\_i = looseIndexOf  
  > &emsp;target.\_m = renderStatic  
  > &emsp;target.\_f = resolveFilter  
  > &emsp;target.\_k = checkKeyCodes  
  > &emsp;target.\_b = bindObjectProps  
  > &emsp;target.\_v = createTextVNode  
  > &emsp;target.\_e = createEmptyVNode  
  > &emsp;target.\_u = resolveScopedSlots  
  > &emsp;target.\_g = bindObjectListeners  
  > }

  在 Vue.prototype 原型添加一系列方法和$nextTick、\_render

在 src/core/instance/index.js 中  
 **vue 的原始出生地，通过 \*Mixin 方法在 Vue.prototype 原型添加方法**  
 **initMixin 添加 \_init 方法**  
 **stateMixin 添加 $data $props $set $delete $watch**  
 **eventsMixin 添加 $on $once $off $emit**  
 **lifecycleMixin 添加 \_update $forceUpdate $destroy**  
 **renderMixin 添加 \_o \_n \_s \_l \_t \_q \_i \_m \_f \_k \_b \_v \_e \_u \_g $nextTick \_render**

在 src/core/index.js 中  
**在 Vue.prototype 原型添加 $isServer $ssrContext**

在 src/platforms/web/runtime/index.js 中  
**在 Vue.prototype 原型添加 **patch** $mount**

在 src/platforms/web/entry-runtime-with-compiler.js 中  
**在 Vue.prototype 原型添加 $mount**

- vue 构造函数的静态属性和方法(全局 API)

  在 src/core/index.js 中导入了 src/core/instance/index.js 暴露的 vue

  > 导入 vue  
  > import Vue from './instance/index'  
  > import { initGlobalAPI } from './global-api/index'  
  > import { isServerRendering } from 'core/util/env'  
  > import { FunctionalRenderContext } from 'core/vdom/create-functional-component'  
  > initGlobalAPI(Vue)  
  > **Vue.prototype 原型上添加$isServer 属性，代理了 isServerRendering 方法**  
  > Object.defineProperty(Vue.prototype, '$isServer', {  
  > &emsp;get: isServerRendering  
  > })  
  > **Vue.prototype 原型上添加$ssrContext 属性**  
  > Object.defineProperty(Vue.prototype, '$ssrContext', {  
  > &emsp;get () {  
  > &emsp;&emsp;/_ istanbul ignore next _/  
  > &emsp;&emsp;return this.$vnode && this.$vnode.ssrContext  
  > }  
  > })  
  > **Vue 上添加 FunctionalRenderContext 属性**  
  > // expose FunctionalRenderContext for ssr runtime helper installation  
  > Object.defineProperty(Vue, 'FunctionalRenderContext', {  
  > &emsp;value: FunctionalRenderContext  
  > })  
  > **Vue.version 保存版本号 rollup 配置(scripts/config.js)中会替换为版本号**  
  > Vue.version = '`__VERSION__`'  
  > export default Vue

在 src/core/global-api/index.js 中

> const configDef = {}  
>  configDef.get = () => config  
>  if (process.env.NODE_ENV !== 'production') {  
>  &emsp;configDef.set = () => {  
>  &emsp;&emsp;warn(  
>  &emsp;&emsp;&emsp;'Do not replace the Vue.config object, set individual fields instead.'  
>  &emsp;&emsp;)  
>  &emsp;}  
>  }  
>  Object.defineProperty(Vue, 'config', configDef)

**在 Vue 上添加 config 属性**

> Vue.util = {  
>  &emsp;warn,  
>  &emsp;extend,  
>  &emsp;mergeOptions,  
>  &emsp;defineReactive  
>  }

**在 Vue 上添加 util 属性**

> Vue.set = set  
>  Vue.delete = del  
>  Vue.nextTick = nextTick  
>  Vue.options = Object.create(null)

**在 Vue 上添加 set、del、nextTick、options**

> ASSET_TYPES.forEach(type => {  
>  &emsp;Vue.options[type + 's'] = Object.create(null)  
>  })  
>  Vue.options.\_base = Vue

这段执行后  
 Vue.options = {  
 &emsp;components: Object.create(null),  
 &emsp;directives: Object.create(null),  
 &emsp;filters: Object.create(null),  
 &emsp;\_base: Vue  
 }

> extend(Vue.options.components, builtInComponents)

将 builtInComponents 混合到 Vue.options.components 中

Vue.options = {  
 &emsp;components: {  
 &emsp;&emsp;KeepAlive  
 &emsp;},  
 &emsp;directives: Object.create(null),  
 &emsp;filters: Object.create(null),  
 &emsp;\_base: Vue  
 }

> import { initUse } from './use'  
>  initUse(Vue)

在 src/core/global-api/use.js

> export function initUse (Vue: GlobalAPI) {  
>  &emsp;Vue.use = function() {  
>  &emsp;&emsp;....  
>  &emsp;}  
>  }

**在 Vue 上添加 use 方法**

> import { initMixin } from './mixin'  
>  initMixin(Vue)

在 src/core/global-api/mixin.js

> export function initMixin (Vue: GlobalAPI) {  
>  &emsp;Vue.mixin = function (mixin: Object) {  
>  &emsp;&emsp;...  
>  &emsp;}  
>  }

**在 Vue 上添加 mixin 方法**

> import { initExtend } from './extend'  
>  initExtend(Vue)

在 src/core/global-api/extend.js

> export function initExtend (Vue: GlobalAPI) {  
>  &emsp;Vue.cid = 0  
>  &emsp;let cid = 1  
>  &emsp;Vue.extend = function (extendOptions: Object): Function {  
>  &emsp;&emsp;...  
>  &emsp;}  
>  }

**在 Vue 添加 cid 属性和 extend 方法**

> import { initAssetRegisters } from './assets'  
>  initAssetRegisters(Vue)

在 src/core/global-api/assets.js

> export function initAssetRegisters (Vue: GlobalAPI) {  
>  &emsp;ASSET_TYPES.forEach( type => {  
>  &emsp;&emsp;Vue[type] = function() {  
>  &emsp;&emsp;&emsp;...  
>  &emsp;&emsp;}  
>  &emsp;})  
>  }

**在 Vue 上添加 component、directive、filter 方法**

src/core/global-api/index.js 做的事  
 **Vue 上添加 config 属性  
 Vue 上添加 util 对象包含 warn、extend、mergeOptions、defineReactive  
 Vue 上添加 set、delete、nextTick  
 Vue 上添加 options 对象  
 Vue.options = {  
 &emsp;components: {  
 &emsp;&emsp;KeepAlive  
 &emsp;},  
 &emsp;directives: Object.create(null),  
 &emsp;filters: Object.create(null),  
 &emsp;\_base: Vue  
 }  
 initUse(Vue) => 在 Vue 上添加 use 方法  
 initMixin(Vue) => 在 Vue 上添加 mixin 方法  
 initExtend(Vue) => 在 Vue 添加 cid 属性和 extend 方法  
 initAssetRegisters(Vue) => 在 Vue 上添加 component、directive、filter 方法**

src/core/index.js  
 **还在 Vue.prototype 原型上添加$isServer、$ssrContext  
 Vue 上添加 FunctionalRenderContext、version**

src/platforms/web/entry-runtime-with-compiler.js  
 **Vue.compile = compileToFunctions**

npm run dev => 执行 src/platforms/web/entry-runtime-with-compiler.js(import Vue from './runtime/index')

src/platforms/web/runtime/index.js(import Vue from 'core/index' 别名配置)

src/core/index.js(import Vue from './instance/index') 为 Vue 添加全局属性方法

src/core/instance/index.js(Vue 出生文件)

- Vue 平台化包装(web 和 weex)

  src/platforms/web/runtime/index.js

  > Vue.config.mustUseProp = mustUseProp  
  > Vue.config.isReservedTag = isReservedTag  
  > Vue.config.isReservedAttr = isReservedAttr  
  > Vue.config.getTagNamespace = getTagNamespace  
  > Vue.config.isUnknownElement = isUnknownElement  
  > Vue.config = {  
  > &emsp;optionMergeStrategies: Object.create(null),  
  > &emsp;silent: false,  
  > &emsp;productionTip: process.env.NODE_ENV !== 'production',  
  > &emsp;devtools: process.env.NODE_ENV !== 'production',  
  > &emsp;performance: false,  
  > &emsp;errorHandler: null,  
  > &emsp;warnHandler: null,  
  > &emsp;ignoredElements: [],  
  > &emsp;keyCodes: Object.create(null),  
  > &emsp;isReservedTag: no,  
  > &emsp;isReservedAttr: no,  
  > &emsp;isUnknownElement: no,  
  > &emsp;getTagNamespace: noop,  
  > &emsp;parsePlatformTagName: identity,  
  > &emsp;mustUseProp: no,  
  > &emsp;\_lifecycleHooks: LIFECYCLE_HOOKS  
  > }

  > import platformDirectives from './directives/index'  
  > import platformComponents from './components/index'  
  > extend(Vue.options.directives, platformDirectives)  
  > extend(Vue.options.components, platformComponents)

  src/platforms/web/runtime/directives/index  
  暴露 model、show 方法  
  src/platforms/web/runtime/components/index  
  暴露 Transition、TransitionGroup 组件

  Vue.options = {  
  &emsp;components: {  
  &emsp;&emsp;KeepAlive,  
  &emsp;&emsp;Transition,  
  &emsp;&emsp;TransitionGroup  
  &emsp;},  
  &emsp;directives: {  
  &emsp;&emsp;model,  
  &emsp;&emsp;show  
  &emsp;},  
  &emsp;filters: Object.create(null),  
  &emsp;\_base: Vue  
  }

  Vue.prototype.`__patch__` = inBrowser ? patch : noop  
  如果是浏览器环境 Vue.prototype.`__patch__` = patch 否则为空函数

  > Vue.prototype.$mount = function() {  
  >  ....  
  > }

  Vue.prototype 原型添加$mount

  src/platforms/web/runtime/index.js 做了  
  **设置平台化的 Vue.config  
  Vue.options.directives 添加 model、show 指令  
  Vue.options.components 添加 Transition、TransitionGroup 组件  
  Vue.prototype 上添加**patch**、$mount**

- with complier

  完整版和运行版区别在于 complier

  src/platforms/web/entry-runtime-with-compiler.js

  > const idToTemplate = cached(id => {  
  > &emsp;const el = query(id)  
  > &emsp;return el && el.innerHTML  
  > })

  通过 id 获取元素的 innerHTML

  > const mount = Vue.prototype.$mount  
  > mount 变量缓存 Vue.prototype.$mount 方法  
  > function getOuterHTML() {  
  > &emsp;....  
  > }  
  > 定义 getOuterHTML 方法  
  > Vue.prototype.$mount = function(){  
  > &emsp;...  
  > }

  重写 Vue.prototype.$mount 方法

  > import { compileToFunctions } from './compiler/index'  
  > Vue.compile = compileToFunctions

  Vue 添加 compile 方法
